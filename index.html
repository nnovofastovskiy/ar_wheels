<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wheel Painter (—Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä)</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #111;
            color: #eee;
            font-family: system-ui;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 8px;
            padding: 8px;
            box-sizing: border-box;
        }

        .viewer {
            position: relative;
            flex: 1;
            overflow: hidden;
            border-radius: 12px;
            background: #000;
        }

        video,
        canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        button {
            background: #2563eb;
            border: 0;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>

<body>
    <div id="app">
        <div class="controls">
            <label>–¶–≤–µ—Ç: <input id="color" type="color" value="#ff0000"></label>
            <button id="detect">üîç –ù–∞–π—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
            <button id="clear">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="snapshot">üì∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <div style="font-size:13px;opacity:0.8;">–ù–∞–π–¥–∏ –º–∞—à–∏–Ω—É ‚Üí —Ç–∞–ø–Ω–∏ –ø–æ –∫–æ–ª—ë—Å–∞–º (2 —Ä–∞–∑–∞)</div>
        </div>

        <div class="viewer">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
        let video, canvas, ctx, model;
        let carBox = null;
        let wheelPoints = [];
        let colorInput;

        async function initCamera() {
            video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }, audio: false
            });
            video.srcObject = stream;
            await new Promise(res => video.onloadedmetadata = res);
        }

        async function main() {
            await initCamera();
            model = await cocoSsd.load();
            console.log('‚úÖ –ú–æ–¥–µ–ª—å COCO-SSD –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            colorInput = document.getElementById('color');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            requestAnimationFrame(drawLoop);
        }

        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        async function detectCar() {
            const preds = await model.detect(video);
            const car = preds.find(p => p.class === 'car' && p.score > 0.5);
            if (car) {
                const [x, y, w, h] = car.bbox;
                carBox = { x, y, w, h };
                wheelPoints = [];
                alert('üöó –ú–∞—à–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —Ç–∞–ø–Ω–∏ –ø–æ –∫–æ–ª—ë—Å–∞–º.');
            } else {
                alert('–ú–∞—à–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π –±–ª–∏–∂–µ/–¥—Ä—É–≥–æ–π —É–≥–æ–ª.');
            }
        }

        function drawLoop() {
            if (!ctx || !video.videoWidth) return requestAnimationFrame(drawLoop);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (carBox) {
                ctx.strokeStyle = 'lime';
                ctx.lineWidth = 2;
                ctx.strokeRect(carBox.x, carBox.y, carBox.w, carBox.h);
            }

            const color = colorInput.value;
            for (const p of wheelPoints) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.closePath();
                ctx.globalAlpha = 0.6;
                ctx.fillStyle = color;
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#fff';
                ctx.stroke();
            }

            requestAnimationFrame(drawLoop);
        }

        // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        canvas = document.getElementById('canvas');
        canvas.addEventListener('click', e => {
            if (!carBox) {
                alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–ù–∞–π—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—å"');
                return;
            }
            if (wheelPoints.length >= 2) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            const r = carBox.h / 6; // —Ä–∞–¥–∏—É—Å –Ω–∞ –≥–ª–∞–∑, –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–∞—à–∏–Ω–µ
            wheelPoints.push({ x, y, r });
            if (wheelPoints.length === 2) alert('‚úÖ –ö–æ–ª—ë—Å–∞ –≤—ã–±—Ä–∞–Ω—ã! –¶–≤–µ—Ç –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.');
        });

        document.getElementById('detect').addEventListener('click', detectCar);
        document.getElementById('clear').addEventListener('click', () => {
            carBox = null;
            wheelPoints = [];
        });

        document.getElementById('snapshot').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'wheel_color.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        main();
    </script>
</body>

</html>